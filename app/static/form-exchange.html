<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario A: Registro de Intercambio - Maxocracia</title>
    <link rel="stylesheet" href="/static/css/vhv.css">
    <link rel="stylesheet" href="/static/css/forms.css">
</head>

<body>
    <div class="forms-container">
        <!-- Hero Section -->
        <div class="forms-hero">
            <h1 class="forms-hero-title">üîÑ Registro de Intercambio Completado</h1>
            <p class="forms-hero-subtitle">
                Este formulario registra intercambios ya realizados en la Red de Apoyo.
                Completa esto despu√©s de coordinar o verificar que un intercambio sucedi√≥.
                Toma menos de 2 minutos. ¬°Gracias por documentar!
            </p>
        </div>

        <!-- Success Message (hidden by default) -->
        <div id="successMessage" class="forms-success" style="display: none;">
            <div class="forms-success-icon">‚úÖ</div>
            <h2 class="forms-success-title">¬°Intercambio Registrado!</h2>
            <p class="forms-success-message" id="successDetails"></p>
            <button class="forms-btn forms-btn-primary" onclick="resetForm()" style="margin-top: 1rem;">
                Registrar Otro Intercambio
            </button>
        </div>

        <!-- Error Message (hidden by default) -->
        <div id="errorMessage" class="forms-error" style="display: none;">
            <span class="forms-error-icon">‚ö†Ô∏è</span>
            <span id="errorText"></span>
        </div>

        <!-- Form -->
        <form id="exchangeForm" class="forms-card">
            <!-- SECCI√ìN 1: Identificaci√≥n del Intercambio -->
            <div class="forms-section">
                <h2 class="forms-section-title">
                    <span class="forms-emoji">üîñ</span>
                    SECCI√ìN 1: Identificaci√≥n del Intercambio
                </h2>

                <div class="forms-group">
                    <label class="forms-label forms-label-required" for="date">Fecha del intercambio</label>
                    <input type="date" id="date" name="date" class="forms-input" required>
                    <span class="forms-help-text">¬øCu√°ndo ocurri√≥ o se coordin√≥ este intercambio?</span>
                </div>

                <div class="forms-group">
                    <label class="forms-label forms-label-required" for="interchange_id">C√≥digo de Intercambio</label>
                    <input type="text" id="interchange_id" name="interchange_id" class="forms-input"
                        placeholder="INT-001" maxlength="20" required>
                    <span class="forms-help-text">Genera un c√≥digo √∫nico. Formato sugerido: INT-001, INT-002,
                        etc.</span>
                </div>
            </div>

            <!-- SECCI√ìN 2: Participantes -->
            <div class="forms-section">
                <h2 class="forms-section-title">
                    <span class="forms-emoji">üë•</span>
                    SECCI√ìN 2: Participantes
                </h2>

                <div class="forms-group">
                    <label class="forms-label forms-label-required" for="giver_name">¬øQui√©n DIO en este
                        intercambio?</label>
                    <input type="text" id="giver_name" name="giver_name" class="forms-input" required>
                    <span class="forms-help-text">Nombre o alias de la persona que ofreci√≥ ayuda/recurso</span>
                </div>

                <div class="forms-group">
                    <label class="forms-label forms-label-required" for="receiver_name">¬øQui√©n RECIBI√ì en este
                        intercambio?</label>
                    <input type="text" id="receiver_name" name="receiver_name" class="forms-input" required>
                    <span class="forms-help-text">Nombre o alias de la persona que recibi√≥ ayuda/recurso</span>
                </div>
            </div>

            <!-- SECCI√ìN 3: Detalles del Intercambio -->
            <div class="forms-section">
                <h2 class="forms-section-title">
                    <span class="forms-emoji">üìã</span>
                    SECCI√ìN 3: Detalles del Intercambio
                </h2>

                <div class="forms-group">
                    <label class="forms-label forms-label-required">Tipo de intercambio</label>
                    <p class="forms-help-text">Selecciona todos los que correspondan</p>
                    <div class="forms-checkbox-group">
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="type_objeto" name="type" value="objeto">
                            <label for="type_objeto">üì¶ Objeto (cosas materiales)</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="type_alimentacion" name="type" value="alimentacion">
                            <label for="type_alimentacion">üçΩ Alimentaci√≥n o Cocina</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="type_habilidad" name="type" value="habilidad">
                            <label for="type_habilidad">üõ† Habilidad o Servicio</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="type_conocimiento" name="type" value="conocimiento">
                            <label for="type_conocimiento">üìö Conocimiento o Consejo</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="type_transporte" name="type" value="transporte">
                            <label for="type_transporte">üöó Transporte o Acompa√±amiento</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="type_tiempo" name="type" value="tiempo">
                            <label for="type_tiempo">‚è∞ Tiempo y Compa√±√≠a</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="type_espacio" name="type" value="espacio">
                            <label for="type_espacio">üè† Espacio</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="type_apoyo_economico" name="type" value="apoyo_economico">
                            <label for="type_apoyo_economico">üí∞ Apoyo Econ√≥mico</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="type_otro" name="type" value="otro">
                            <label for="type_otro">üîÑ Otro (especificar abajo)</label>
                        </div>
                    </div>
                </div>

                <div class="forms-group">
                    <label class="forms-label forms-label-required" for="description">Descripci√≥n breve del
                        intercambio</label>
                    <textarea id="description" name="description" class="forms-textarea" required
                        placeholder="Ejemplo: 'Leonidas comparti√≥ ingredientes para preparar comida de una semana' o 'Max dio mentor√≠a sobre estrategia laboral por videollamada'"></textarea>
                </div>

                <div class="forms-group">
                    <label class="forms-label forms-label-required">Urgencia de la necesidad que se atendi√≥</label>
                    <div class="forms-radio-group">
                        <div class="forms-radio-item">
                            <input type="radio" id="urgency_alta" name="urgency" value="Alta" required>
                            <label for="urgency_alta">üî¥ Alta Urgencia</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="urgency_media" name="urgency" value="Media">
                            <label for="urgency_media">üü° Media Urgencia</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="urgency_baja" name="urgency" value="Baja">
                            <label for="urgency_baja">üü¢ Baja Urgencia</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN 4: M√©tricas Maxocr√°ticas -->
            <div class="forms-section">
                <h2 class="forms-section-title">
                    <span class="forms-emoji">üìä</span>
                    SECCI√ìN 4: M√©tricas Maxocr√°ticas (Opcional pero recomendado)
                </h2>
                <p class="forms-section-description">
                    Las siguientes preguntas nos ayudan a entender el "costo real" del intercambio.
                    No te preocupes si no sabes responder con exactitud, son estimaciones.
                </p>

                <div class="forms-group">
                    <label class="forms-label" for="uth_hours">Tiempo humano invertido (UTH - Unidades de Tiempo
                        Humano)</label>
                    <div class="forms-input-group">
                        <input type="number" id="uth_hours" name="uth_hours" class="forms-input" step="0.5" min="0"
                            placeholder="2.5">
                        <span class="forms-input-addon">horas</span>
                    </div>
                    <span class="forms-help-text">¬øCu√°ntas horas dedic√≥ la persona que DIO? Ejemplo: '2 horas' o '0.5'
                        (30 minutos)</span>
                </div>

                <div class="forms-group">
                    <label class="forms-label" for="economic_value">Valor econ√≥mico aproximado (si aplica)</label>
                    <div class="forms-input-group">
                        <span class="forms-input-addon">$</span>
                        <input type="text" id="economic_value" name="economic_value" class="forms-input"
                            placeholder="20000">
                    </div>
                    <span class="forms-help-text">Si hubo costo monetario (ingredientes, transporte, materiales).
                        Ejemplo: '$20,000' o 'N/A'</span>
                </div>

                <div class="forms-group">
                    <label class="forms-label" for="urf_description">Recursos f√≠sicos consumidos (si aplica)</label>
                    <textarea id="urf_description" name="urf_description" class="forms-textarea"
                        placeholder="Ejemplo: '2kg arroz, 1kg pollo' o 'Silla de escritorio'"></textarea>
                    <span class="forms-help-text">Objetos entregados, ingredientes usados, materiales</span>
                </div>
            </div>

            <!-- SECCI√ìN 5: Impacto y Seguimiento -->
            <div class="forms-section">
                <h2 class="forms-section-title">
                    <span class="forms-emoji">üéØ</span>
                    SECCI√ìN 5: Impacto y Seguimiento
                </h2>

                <div class="forms-group">
                    <label class="forms-label forms-label-required">¬øSe resolvi√≥ la necesidad?</label>
                    <p class="forms-help-text">Seg√∫n tu evaluaci√≥n, ¬øqu√© tan bien se atendi√≥ la necesidad?</p>
                    <div class="forms-radio-group">
                        <div class="forms-radio-item">
                            <input type="radio" id="resolution_1" name="impact_resolution_score" value="1" required>
                            <label for="resolution_1">1 - No se resolvi√≥</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="resolution_2" name="impact_resolution_score" value="2">
                            <label for="resolution_2">2 - Parcialmente</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="resolution_3" name="impact_resolution_score" value="3">
                            <label for="resolution_3">3 - Moderadamente</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="resolution_4" name="impact_resolution_score" value="4">
                            <label for="resolution_4">4 - Bien resuelto</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="resolution_5" name="impact_resolution_score" value="5">
                            <label for="resolution_5">5 - Completamente resuelta</label>
                        </div>
                    </div>
                </div>

                <div class="forms-group">
                    <label class="forms-label forms-label-required">¬øHubo reciprocidad inmediata?</label>
                    <div class="forms-radio-group">
                        <div class="forms-radio-item">
                            <input type="radio" id="reciprocity_mutual" name="reciprocity_status" value="mutual"
                                required>
                            <label for="reciprocity_mutual">S√≠ - Hubo intercambio mutuo en el mismo encuentro</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="reciprocity_unidirectional" name="reciprocity_status"
                                value="unidirectional">
                            <label for="reciprocity_unidirectional">No - Fue ayuda unidireccional (por ahora)</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="reciprocity_future" name="reciprocity_status" value="future">
                            <label for="reciprocity_future">Reciprocidad futura acordada</label>
                        </div>
                    </div>
                </div>

                <div class="forms-group">
                    <label class="forms-label">Dimensi√≥n humana atendida</label>
                    <p class="forms-help-text">¬øQu√© aspecto de la vida de la persona se benefici√≥?</p>
                    <div class="forms-checkbox-group">
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="dim_crecimiento" name="human_dimension"
                                value="crecimiento_aprendizaje">
                            <label for="dim_crecimiento">Crecimiento y Aprendizaje</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="dim_bienestar" name="human_dimension" value="bienestar_descanso">
                            <label for="dim_bienestar">Bienestar y Descanso</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="dim_seguridad" name="human_dimension"
                                value="seguridad_estabilidad">
                            <label for="dim_seguridad">Seguridad y Estabilidad</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="dim_autoestima" name="human_dimension"
                                value="autoestima_autonomia">
                            <label for="dim_autoestima">Autoestima y Autonom√≠a</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="dim_conexion" name="human_dimension" value="conexion_social">
                            <label for="dim_conexion">Conexi√≥n Social y Pertenencia</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="dim_prosperidad" name="human_dimension"
                                value="prosperidad_recursos">
                            <label for="dim_prosperidad">Prosperidad y Recursos</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="dim_placer" name="human_dimension" value="placer_goce">
                            <label for="dim_placer">Placer y Goce de la Vida</label>
                        </div>
                        <div class="forms-checkbox-item">
                            <input type="checkbox" id="dim_intimidad" name="human_dimension" value="intimidad_vinculos">
                            <label for="dim_intimidad">Intimidad y V√≠nculos Afectivos</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN 6: Notas del Facilitador -->
            <div class="forms-section">
                <h2 class="forms-section-title">
                    <span class="forms-emoji">üìù</span>
                    SECCI√ìN 6: Notas del Facilitador
                </h2>

                <div class="forms-group">
                    <label class="forms-label forms-label-required">¬øC√≥mo se coordin√≥ este intercambio?</label>
                    <div class="forms-radio-group">
                        <div class="forms-radio-item">
                            <input type="radio" id="coord_max" name="coordination_method" value="max_direct" required>
                            <label for="coord_max">Coordinaci√≥n directa por Max</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="coord_alone" name="coordination_method" value="participants_alone">
                            <label for="coord_alone">Los participantes se conectaron solos despu√©s del match</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="coord_intermediary" name="coordination_method" value="intermediary">
                            <label for="coord_intermediary">A trav√©s de intermediario (especificar en notas)</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="coord_other" name="coordination_method" value="other">
                            <label for="coord_other">Otro</label>
                        </div>
                    </div>
                </div>

                <div class="forms-group">
                    <label class="forms-label" for="facilitator_notes">Observaciones y aprendizajes</label>
                    <textarea id="facilitator_notes" name="facilitator_notes" class="forms-textarea"
                        placeholder="¬øAlgo importante que notar? ¬øDesaf√≠os? ¬øSorpresas positivas? Esto ayuda a mejorar el sistema"></textarea>
                </div>

                <div class="forms-group">
                    <label class="forms-label forms-label-required">¬øRequiere seguimiento?</label>
                    <div class="forms-radio-group">
                        <div class="forms-radio-item">
                            <input type="radio" id="followup_yes" name="requires_followup" value="1" required>
                            <label for="followup_yes">‚úÖ S√≠ - Necesita seguimiento</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="followup_no" name="requires_followup" value="0">
                            <label for="followup_no">‚ùå No - Intercambio completado</label>
                        </div>
                        <div class="forms-radio-item">
                            <input type="radio" id="followup_ongoing" name="requires_followup" value="1">
                            <label for="followup_ongoing">‚è∏ En proceso - Intercambio de largo plazo</label>
                        </div>
                    </div>
                </div>

                <div class="forms-group" id="followupDateGroup" style="display: none;">
                    <label class="forms-label" for="followup_date">Fecha de seguimiento programado</label>
                    <input type="date" id="followup_date" name="followup_scheduled_date" class="forms-input">
                    <span class="forms-help-text">¬øCu√°ndo hacer el pr√≥ximo seguimiento?</span>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="forms-btn forms-btn-primary forms-btn-full" id="submitBtn">
                <span id="submitText">Registrar Intercambio</span>
                <span id="submitLoading" class="forms-loading" style="display: none;"></span>
            </button>
        </form>
    </div>

    <script src="/static/js/forms.js"></script>
    <script>
        // Show/hide followup date based on selection
        document.querySelectorAll('input[name="requires_followup"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const followupDateGroup = document.getElementById('followupDateGroup');
                if (this.value === '1') {
                    followupDateGroup.style.display = 'block';
                } else {
                    followupDateGroup.style.display = 'none';
                }
            });
        });

        // Set default date to today
        document.getElementById('date').valueAsDate = new Date();

        // Initialize form submission
        document.getElementById('exchangeForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            // Get auth token
            const token = localStorage.getItem('access_token');
            if (!token) {
                showError('Debes iniciar sesi√≥n para registrar intercambios');
                return;
            }

            // Collect form data
            const formData = {
                interchange_id: document.getElementById('interchange_id').value,
                date: document.getElementById('date').value,
                giver_id: 1, // TODO: Get from participant lookup
                receiver_id: 2, // TODO: Get from participant lookup
                type: getCheckedValues('type').join(','),
                description: document.getElementById('description').value,
                urgency: document.querySelector('input[name="urgency"]:checked').value,
                uth_hours: parseFloat(document.getElementById('uth_hours').value) || null,
                economic_value_approx: document.getElementById('economic_value').value || null,
                urf_description: document.getElementById('urf_description').value || null,
                impact_resolution_score: parseInt(document.querySelector('input[name="impact_resolution_score"]:checked').value),
                reciprocity_status: document.querySelector('input[name="reciprocity_status"]:checked').value,
                human_dimension_attended: getCheckedValues('human_dimension').join(','),
                coordination_method: document.querySelector('input[name="coordination_method"]:checked').value,
                requires_followup: parseInt(document.querySelector('input[name="requires_followup"]:checked').value),
                followup_scheduled_date: document.getElementById('followup_date').value || null,
                facilitator_notes: document.getElementById('facilitator_notes').value || null
            };

            // Submit form
            await submitExchangeForm(formData, token);
        });

        function getCheckedValues(name) {
            return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`))
                .map(cb => cb.value);
        }

        async function submitExchangeForm(data, token) {
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');

            // Show loading state
            submitBtn.disabled = true;
            submitText.style.display = 'none';
            submitLoading.style.display = 'inline-block';
            errorMessage.style.display = 'none';

            try {
                const response = await fetch('/forms/exchange', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Show success message
                    document.getElementById('successDetails').textContent =
                        `Intercambio ${data.interchange_id} registrado exitosamente.`;
                    document.getElementById('exchangeForm').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    // Show error message
                    errorText.textContent = result.error || 'Ocurri√≥ un error al enviar el formulario';
                    errorMessage.style.display = 'flex';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                errorText.textContent = 'Error de conexi√≥n. Por favor intenta de nuevo.';
                errorMessage.style.display = 'flex';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                submitLoading.style.display = 'none';
            }
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorMessage.style.display = 'flex';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('exchangeForm').reset();
            document.getElementById('exchangeForm').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('date').valueAsDate = new Date();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>

</html>